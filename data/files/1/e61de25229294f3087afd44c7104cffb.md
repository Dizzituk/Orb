# Orb Architecture Map

**Version:** 0.8.0 (Architecture Map v5)  
**Last Updated:** 30 November 2025  
**Purpose:** Canonical architecture reference for the Orb multi-LLM AI assistant system

---

## Table of Contents

1. [System Overview](#system-overview)  
2. [Component Architecture](#component-architecture)  
3. [Backend (`Orb`)](#backend-orb)  
4. [Desktop Client (`orb-desktop`)](#desktop-client-orb-desktop)  
5. [Data Layer](#data-layer)  
6. [Authentication System](#authentication-system)  
7. [Multi-LLM Orchestration](#multi-llm-orchestration)  
8. [File Ingestion Pipeline](#file-ingestion-pipeline)  
9. [Image Analysis Pipeline](#image-analysis-pipeline)  
10. [Future Capabilities](#future-capabilities)  
11. [Changelog](#changelog)

---

## System Overview

Orb is a personal AI assistant built as a multi-component system with specialized LLM roles:

- **GPT (OpenAI)** — Fast/lightweight reasoning, conversational interface, linguistics  
- **Claude (Anthropic)** — Flagship engineer, complex code, architecture design  
- **Gemini (Google)** — Critic, reviewer, analyst, vision specialist  

### Core Vision

Different AI models specialize in distinct roles while sharing a unified memory layer, enabling:

- Persistent knowledge management across conversations  
- Task coordination and project organization  
- Job-type-based automatic model routing  
- File upload with text extraction and document analysis  
- CV parsing with structured data extraction  
- Image analysis via Gemini Vision  
- RAG-based document retrieval for Q&A  
- **API key authentication for all protected endpoints**

### Technology Stack

**Backend:**

- FastAPI (Python 3.13)  
- SQLAlchemy ORM  
- SQLite database  
- Pydantic schemas  
- `python-multipart` for `multipart/form-data` file uploads  
- `python-docx` for DOCX text extraction  
- `PyMuPDF` (fitz) for PDF text extraction  
- `google-generativeai` for Gemini Vision  

**Desktop Client:**

- Electron (v33.0.0)  
- React 18 with TypeScript 5  
- Vite 5 (build tool and dev server)  
- Custom React hooks for state management  

**Platform:** Windows 11

---

## Component Architecture

```text
D:/
├── Orb/                        # Backend (FastAPI server)
│   ├── main.py                 # Application entrypoint, chat endpoints
│   ├── .env                    # API keys (OPENAI, ANTHROPIC, GOOGLE, GEMINI_VISION_MODEL)
│   ├── app/
│   │   ├── db.py               # Database configuration
│   │   ├── auth/               # Authentication module (NEW)
│   │   ├── memory/             # Memory subsystem (projects/notes/tasks/files/messages/documents)
│   │   └── llm/                # LLM routing module + vision
│   ├── data/                   # SQLite DB + file storage + auth config
│   │   ├── orb_memory.db       # SQLite database
│   │   ├── auth.json           # API key storage (NEW)
│   │   └── files/              # Per-project file storage
│   │       └── {project_id}/   # Uploaded project files (CVs, docs, images, etc.)
│   └── static/                 # Web-based test UI
│
├── orb-desktop/                # Electron + React desktop client
│   ├── main.js                 # Electron main process
│   ├── index.html              # React mount point + CSP config
│   ├── package.json            # Dependencies + scripts
│   ├── vite.config.ts          # Vite configuration
│   ├── tsconfig.json           # TypeScript configuration
│   └── src/
│       ├── main.tsx            # React entry point
│       ├── App.tsx             # Root component with auth integration
│       ├── components/         # React components (inc. AuthScreen)
│       ├── hooks/              # Custom React hooks (inc. useAuth)
│       ├── services/           # API client layer with auth headers
│       ├── styles/             # CSS styles
│       └── types/              # TypeScript type definitions
│
└── orb-electron-data/          # Electron userData directory
    └── [cache, logs, settings] # NOT PART OF CODEBASE
```

---

## Backend (`Orb`)

**Location:** `D:/Orb/`  
**Framework:** FastAPI  
**Entry Point:** `main.py`  
**Version:** 0.8.0

### Directory Structure

```text
Orb/
├── main.py                 # FastAPI app, endpoints, context building, RAG
├── chat_memory.py          # Legacy in-memory chat store (not currently used)
├── .env                    # API keys and configuration
├── start_orb_backend.bat   # Windows startup script
│
├── app/
│   ├── __init__.py
│   ├── db.py               # Database engine, session factory, Base
│   │
│   ├── auth/               # Authentication module (NEW in v0.8.0)
│   │   ├── __init__.py     # Exports: require_auth, get_api_key, etc.
│   │   ├── config.py       # API key generation, storage, validation
│   │   ├── middleware.py   # FastAPI auth dependency
│   │   └── router.py       # Auth endpoints (/auth/*)
│   │
│   ├── memory/             # Memory subsystem
│   │   ├── __init__.py
│   │   ├── models.py       # SQLAlchemy ORM models (inc. DocumentContent)
│   │   ├── schemas.py      # Pydantic request/response schemas
│   │   ├── service.py      # Business logic (CRUD operations)
│   │   └── router.py       # FastAPI route handlers (protected)
│   │
│   └── llm/                # LLM routing module
│       ├── __init__.py     # Exports: call_llm, LLMTask, LLMResult, JobType, analyze_image, etc.
│       ├── schemas.py      # JobType enum, LLMTask/LLMResult models, RoutingConfig
│       ├── clients.py      # Provider API wrappers (internal only)
│       ├── router.py       # Main router with call_llm() function
│       ├── gemini_vision.py # Gemini Vision client for image analysis
│       └── file_analyzer.py # Text extraction and document analysis
│
├── data/
│   ├── orb_memory.db       # SQLite database file
│   ├── auth.json           # API key configuration (NEW)
│   └── files/              # On-disk storage for uploaded project files
│       └── {project_id}/   # Project-specific file directories
│
├── static/                 # Web-based test interface
│   ├── index.html
│   └── renderer.js
│
└── .venv/                  # Python virtual environment
```

### Environment Configuration (`.env`)

```env
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_API_KEY=AIza...
GEMINI_VISION_MODEL=gemini-2.0-flash
```

### Core Modules

#### `main.py`

- FastAPI app initialization with CORS middleware  
- Database initialization on startup  
- Environment variable validation on startup  
- **Authentication status check on startup**
- Context building functions:
  - `build_context_block(db, project_id)` — fetches recent notes + open tasks  
  - `build_document_context(db, project_id, user_message)` — RAG retrieval for uploaded documents  
- Endpoints:
  - `GET /` — serves static UI (public)
  - `GET /ping` — health check (public)
  - `GET /auth/*` — authentication endpoints (public)
  - `POST /chat` — main chat endpoint with RAG **(protected)**
  - `POST /chat_with_attachments` — file upload with extraction/analysis **(protected)**
  - `POST /llm` — direct LLM call **(protected)**
  - `GET /providers` — which provider keys are configured **(protected)**
  - `GET /job-types` — list configured job types **(protected)**
  - `/memory/*` — all memory routes **(protected)**

#### CORS Configuration

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",   # Vite dev server
        "http://localhost:8000",   # Backend itself
        "http://127.0.0.1:5173",
        "http://127.0.0.1:8000",
        "file://",                 # Electron file:// protocol
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## Authentication System

### Overview

Orb uses API key authentication to protect sensitive endpoints. Keys are generated on first run and stored locally.

### Auth Module (`app/auth/`)

#### `config.py` — Key Management

```python
AUTH_CONFIG_PATH = Path("data/auth.json")

def generate_api_key(regenerate: bool = False) -> Optional[str]:
    """Generate a new API key (format: orb_<32 hex chars>)."""

def validate_api_key(provided_key: str) -> bool:
    """Validate a provided API key against stored hash."""

def is_auth_configured() -> bool:
    """Check if API key authentication is configured."""

def get_api_key() -> Optional[str]:
    """Get the current API key (plain text, for dev convenience)."""

def revoke_api_key() -> bool:
    """Revoke the current API key."""
```

Key storage (`data/auth.json`):
```json
{
  "api_key_hash": "sha256 hash of key",
  "api_key_plain": "orb_abc123...",
  "created_at": "2025-11-30T12:00:00",
  "last_used": "2025-11-30T12:30:00"
}
```

#### `middleware.py` — FastAPI Dependencies

```python
async def require_auth(credentials: HTTPAuthorizationCredentials) -> AuthResult:
    """
    Dependency that requires valid authentication.
    Raises 401 for missing/invalid key, 503 if auth not configured.
    """

async def optional_auth(credentials: HTTPAuthorizationCredentials) -> AuthResult:
    """
    Dependency that checks auth without requiring it.
    Returns AuthResult with authenticated=True/False.
    """
```

#### `router.py` — Auth Endpoints

| Endpoint | Method | Auth Required | Description |
|----------|--------|---------------|-------------|
| `/auth/status` | GET | No | Check if auth is configured |
| `/auth/setup` | POST | No | Generate initial API key |
| `/auth/validate` | POST | No | Validate an API key |
| `/auth/regenerate` | POST | Yes | Generate new key (invalidates old) |
| `/auth/revoke` | POST | Yes | Revoke current key |
| `/auth/key` | GET | Yes | Get current key (dev convenience) |

### Protected Endpoints

All these endpoints require `Authorization: Bearer <api_key>` header:

| Endpoint | Description |
|----------|-------------|
| `POST /chat` | Chat with LLM |
| `POST /chat_with_attachments` | Chat with file uploads |
| `POST /llm` | Direct LLM call |
| `GET /providers` | List available providers |
| `GET /job-types` | List job types |
| `/memory/*` | All memory CRUD operations |

### Frontend Integration

#### `useAuth` Hook

```typescript
interface UseAuthResult {
  status: 'checking' | 'not_configured' | 'needs_key' | 'authenticated' | 'error';
  apiKey: string | null;
  error: string | null;
  
  setupNewKey: () => Promise<string | null>;
  enterKey: (key: string) => Promise<boolean>;
  logout: () => void;
  recheckAuth: () => Promise<void>;
}
```

#### `AuthScreen` Component

Handles three states:
1. **Not Configured** — "Generate API Key" button
2. **Needs Key** — API key input field
3. **Key Generated** — Shows key for copying (one-time display)

#### API Service Auth Headers

```typescript
function getAuthHeaders(): HeadersInit {
  const apiKey = localStorage.getItem('orb_api_key');
  return apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {};
}
```

### Security Notes

- API keys are hashed (SHA256) for storage comparison
- Plain key stored in `auth.json` for local dev convenience
- Keys stored in localStorage (frontend) — will move to Electron secure storage in Phase 3
- 401 returned for invalid/missing credentials
- 503 returned if auth not yet configured

---

### LLM Routing Module (`app/llm/`)

Routing layer for all model calls plus file analysis utilities.

#### `__init__.py` — Exports

```python
from .router import call_llm, quick_chat, request_code, review_work
from .schemas import LLMTask, LLMResult, JobType, Provider, RoutingConfig
from .gemini_vision import analyze_image, is_image_mime_type
from .file_analyzer import (
    extract_text_content,
    detect_document_type,
    parse_cv_with_llm,
    generate_document_summary,
)
```

#### `schemas.py` — Types and Routing Config

- `JobType` enum:
  - GPT-only: `casual_chat`, `note_cleanup`, `copywriting`, `prompt_shaping`, `summary`, `explanation`
  - Medium dev: `simple_code_change`, `small_bugfix`
  - Claude (engineering): `complex_code_change`, `codegen_full_file`, `architecture_design`, `code_review`, `spec_review`, `refactor`, `implementation_plan`
  - High-stakes: `high_stakes_infra`, `security_sensitive_change`, `privacy_sensitive_change`, `public_app_packaging`
  - Gemini: `image_analysis`, `screenshot_analysis`, `video_analysis`
- `Provider` enum: `OPENAI`, `ANTHROPIC`, `GOOGLE`
- `LLMTask`, `LLMResult`, `RoutingConfig`

#### `clients.py`

Provider wrappers (internal):

- `call_openai(...)`
- `call_anthropic(...)`
- `call_google(...)`
- `check_provider_availability()`

Models:

- OpenAI: `gpt-4.1-mini`
- Anthropic: `claude-sonnet-4`
- Google: `gemini-2.0-flash`

#### `router.py`

- `call_llm(task: LLMTask) -> LLMResult` — single entry point  
- Convenience helpers:
  - `quick_chat(...)` → GPT  
  - `request_code(...)` → Claude  
  - `review_work(...)` → Gemini  
- Enforces Claude rules:
  - Ask for full file before edits  
  - Return complete files, no diffs/snippets  

#### `gemini_vision.py` — Image Analysis

```python
def analyze_image(image_bytes: bytes, mime_type: str, user_prompt: Optional[str] = None) -> dict:
    """
    Analyze an image using Gemini Vision.
    
    Returns:
        dict with keys: summary, tags, type, and optionally error
    """
```

Features:
- Lazy-loads Gemini model on first use
- Reads `GOOGLE_API_KEY` and `GEMINI_VISION_MODEL` from environment
- Handles multiple `.env` file locations as fallback
- Returns structured JSON with summary, tags, and image type
- Graceful error handling — returns error dict instead of raising

#### `file_analyzer.py` — Document Processing

```python
def extract_text_content(file_path: str) -> Optional[str]:
    """Extract text from DOCX, PDF, TXT, MD, and other text files."""

def detect_document_type(filename: str, content: str) -> str:
    """Detect document type: cv, code, config, data, document."""

def parse_cv_with_llm(raw_text: str, filename: str, llm_call_fn) -> dict:
    """Parse CV into structured data: name, summary, roles, skills, education."""

def generate_document_summary(raw_text: str, filename: str, doc_type: str, llm_call_fn) -> str:
    """Generate a 2-3 sentence summary of a document."""
```

Supported file types:
- `.docx` — via `python-docx` (paragraphs + tables)
- `.pdf` — via `PyMuPDF` (fitz)
- `.txt`, `.md`, `.csv`, `.json`, `.xml`, `.yaml` — plain text
- `.py`, `.js`, `.ts`, `.html`, `.css` — code files

---

## Memory Subsystem (`app/memory/`)

Project-based knowledge management with document content storage.

**Note:** All `/memory/*` endpoints are now protected by authentication.

### `models.py` — ORM Models

```python
class Project:
    id, name, description, created_at, updated_at
    # Relationships: notes, tasks, files, messages, document_contents

class Note:
    id, project_id, title, content, tags, source, created_at, updated_at

class Task:
    id, project_id, title, description, status, priority, created_at, updated_at

class File:
    id, project_id, path, original_name, file_type, description, created_at
    # Relationship: document_content (one-to-one)

class Message:
    id, project_id, role, content, created_at

class DocumentContent:
    id, project_id, file_id, filename, doc_type
    raw_text        # Full extracted text
    summary         # LLM-generated summary
    structured_data # JSON string (e.g., parsed CV data)
    created_at
```

### `router.py` — Protected Routes

```python
router = APIRouter(
    prefix="/memory",
    tags=["memory"],
    dependencies=[Depends(require_auth)],  # All routes protected
)
```

---

## Desktop Client (`orb-desktop`)

React + TypeScript Electron application with authentication.

**Location:** `D:/orb-desktop/`  
**Framework:** React 18, TypeScript 5, Vite 5, Electron 33

### Key Files

```text
src/
├── App.tsx                 # Root component with auth gate
├── components/
│   ├── AuthScreen.tsx      # Login/setup screen (NEW)
│   ├── Header.tsx          # Now includes logout button
│   └── ...
├── hooks/
│   ├── useAuth.ts          # Auth state management (NEW)
│   └── ...
├── services/
│   └── api.ts              # API client with auth headers
└── styles/
    └── index.css           # Includes auth screen styles
```

### Auth Flow

```text
App starts
    │
    ▼
useAuth checks /auth/status
    │
    ├── Not configured → AuthScreen (setup)
    │                         │
    │                         ▼
    │                    Click "Generate API Key"
    │                         │
    │                         ▼
    │                    POST /auth/setup
    │                         │
    │                         ▼
    │                    Show key (save it!)
    │                         │
    │                         ▼
    │                    Store in localStorage
    │
    ├── Needs key → AuthScreen (login)
    │                    │
    │                    ▼
    │               Enter API key
    │                    │
    │                    ▼
    │               POST /auth/validate
    │                    │
    │                    ▼
    │               Store in localStorage
    │
    └── Authenticated → Main App UI
```

---

## Data Layer

### Database

- SQLite at `data/orb_memory.db`
- Tables: `projects`, `notes`, `tasks`, `files`, `messages`, `document_contents`

### Files on Disk

- Folder structure: `data/files/{project_id}/`
- DB `File.path` stores relative `files/{project_id}/{uuid}.{ext}`
- Images, documents, and all uploaded files stored here

### Auth Config

- Location: `data/auth.json`
- Contains: hashed API key, plain key (dev), timestamps

---

## Multi-LLM Orchestration

### Job-Type Based Routing

- `/chat` uses `JobType` to decide provider(s)
- GPT for low-stakes text, Claude for engineering, Gemini for reviews/vision
- High-stakes flows may route to Claude and then have Gemini critique

### RAG Document Retrieval

The `/chat` endpoint includes RAG-based document context:

```python
def build_document_context(db, project_id, user_message):
    # 1. Check for CV-related keywords
    # 2. Check for filename mentions
    # 3. Keyword match against document content
    # 4. Fall back to most recent document
    # 5. Build context with structured_data + summary + raw_text excerpt
```

System prompt instructs LLM to use UPLOADED DOCUMENTS section for answers.

### Response Shape

```json
{
  "project_id": 1,
  "provider": "anthropic",
  "reply": "Based on your CV, you worked as a Bar Manager at Cosy Club from March to October 2017...",
  "was_reviewed": false,
  "critic_review": null,
  "attachments_summary": [
    {
      "client_filename": "Tazzid Ingram cv.docx",
      "stored_id": "file_1",
      "type": "cv",
      "summary": "CV for Tazzid Ingram with 5 work experiences, skills include: ...",
      "tags": ["cv", "resume", "docx"]
    }
  ]
}
```

---

## File Ingestion Pipeline

### Flow: Document Upload → Extraction → Storage → Q&A

```text
User uploads file
       │
       ▼
POST /chat_with_attachments (requires auth)
       │
       ├── Save to data/files/{project_id}/{uuid}.{ext}
       │
       ├── Detect MIME type
       │         │
       │         ├── image/* → analyze_image() via Gemini Vision
       │         │
       │         └── document → extract_text_content()
       │                              │
       │                              ├── .docx → python-docx
       │                              ├── .pdf  → PyMuPDF
       │                              └── .txt/.md → plain read
       │
       ├── detect_document_type() → cv | code | config | document
       │
       ├── If CV: parse_cv_with_llm() → structured JSON
       │   {name, summary, roles[], skills[], education[]}
       │
       ├── generate_document_summary()
       │
       ├── Create File record in DB
       │
       ├── Create DocumentContent record
       │   (raw_text, summary, structured_data)
       │
       └── Return ChatResponse with attachments_summary
```

---

## Image Analysis Pipeline

### Flow: Image Upload → Gemini Vision → Storage

```text
User uploads image
       │
       ▼
POST /chat_with_attachments (requires auth)
       │
       ├── Save to data/files/{project_id}/{uuid}.png
       │
       ├── Detect image/* MIME type
       │
       ├── analyze_image(file_bytes, mime_type, user_prompt)
       │         │
       │         ├── Load GOOGLE_API_KEY from .env
       │         ├── Initialize Gemini model (lazy)
       │         ├── Send image + prompt to Gemini Vision
       │         └── Parse JSON response: {summary, tags, type}
       │
       ├── Create File record
       │
       ├── Create DocumentContent record
       │   (raw_text = "[Image: filename] summary")
       │
       └── Return ChatResponse with image summary
```

### Gemini Vision Configuration

```env
GOOGLE_API_KEY=AIza...
GEMINI_VISION_MODEL=gemini-2.0-flash  # or gemini-3-pro-preview
```

---

## Future Capabilities

### Security Roadmap

- **Phase 2: Database Encryption** — SQLCipher or field-level encryption
- **Phase 3: Secure Key Storage** — Move from localStorage to Electron secure storage / Windows Credential Manager
- **Phase 4: Audit Logging** — Track all API access with timestamps

### Feature Roadmap

1. **Semantic Search Over Notes & Files**
   - Embedding-based retrieval for long-term memory
   - Vector store integration (ChromaDB or similar)

2. **Streaming Responses**
   - Token streaming in Electron UI
   - Server-sent events from FastAPI

3. **More Tools / Function Calling**
   - LLM-triggered tools for internal Orb operations
   - Calendar integration, web search, etc.

4. **Project Selector UI**
   - Currently hardcoded to Project ID 1
   - Add project creation/selection in desktop client

5. **Web Search Grounding**
   - Real-time web search for current information
   - Gemini grounding API integration

6. **Voice Input/Output**
   - Speech-to-text for input
   - Text-to-speech for responses

---

## Changelog

### v0.8.0 — API Authentication (30 Nov 2025)

**Backend:**

- New `app/auth/` module with API key authentication
- `config.py`: Key generation, hashing (SHA256), storage, validation
- `middleware.py`: `require_auth` FastAPI dependency
- `router.py`: Auth endpoints (`/auth/status`, `/auth/setup`, `/auth/validate`, etc.)
- All sensitive endpoints now protected (401 for invalid key, 503 if not configured)
- Memory router protected via router-level dependency
- Auth config stored in `data/auth.json`
- Startup logs auth status

**Frontend:**

- New `useAuth` hook for auth state management
- New `AuthScreen` component for setup/login
- API service updated with `Authorization: Bearer` headers
- Header component now includes logout button
- API key stored in localStorage
- Auth gate in App.tsx — shows AuthScreen if not authenticated

### v0.7.1 — Image Analysis Pipeline (30 Nov 2025)

- Fixed `gemini_vision.py` to properly load `.env` with `load_dotenv()`
- Added fallback `.env` path detection
- Improved error handling — returns error dict instead of crashing
- Added startup environment variable validation
- Added debug logging throughout image analysis flow

### v0.7.0 — React Migration + File Ingestion (29-30 Nov 2025)

**Desktop Client (orb-desktop):**

- Complete rewrite from vanilla JavaScript to React 18 + TypeScript 5
- Vite 5 as build tool and dev server
- Custom hooks architecture: `useChat`, `useAttachments`, `useCodeFiles`
- Typed API service layer
- Two-column layout: ChatWindow + CodeFilesPanel
- Component-based UI: Header, MessageBubble, AttachmentBar, InputSection
- CSP configuration for blob: image previews
- Concurrent dev workflow: Vite + Electron

**Backend (Orb):**

- New `POST /chat_with_attachments` endpoint for file uploads
- Text extraction pipeline: DOCX (python-docx), PDF (PyMuPDF), TXT
- Document type detection: cv, code, config, document
- CV parsing with structured data extraction (roles, skills, education)
- `DocumentContent` model for storing extracted text and summaries
- RAG-based document retrieval in `/chat` endpoint
- `build_document_context()` for intelligent document selection
- Gemini Vision integration for image analysis
- CORS middleware for localhost:5173 (Vite dev server)

**Dependencies Added:**

- `python-docx` — DOCX text extraction
- `PyMuPDF` — PDF text extraction
- `google-generativeai` — Gemini Vision API

### v0.6.0 — File Upload Plumbing (28 Nov 2025)

- Added real file upload into Orb backend
- `POST /memory/projects/{project_id}/files/upload` with `multipart/form-data`
- `File` ORM row created via `service.create_file_for_project`
- Electron desktop: attachment button and drag-drop wired to backend

---

## Quick Start

### Backend

```powershell
cd D:\Orb
.venv\Scripts\activate
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Desktop Client

```powershell
cd D:\orb-desktop
npm run electron:dev
```

### First-Time Auth Setup

1. Start backend and frontend
2. Orb shows "Welcome to Orb" auth screen
3. Click "Generate API Key"
4. **SAVE THE KEY** — shown only once (also in `D:\Orb\data\auth.json`)
5. Continue to main app

### Verify `.env`

```powershell
Get-Content D:\Orb\.env
# Should show:
# OPENAI_API_KEY=sk-...
# ANTHROPIC_API_KEY=sk-ant-...
# GOOGLE_API_KEY=AIza...
# GEMINI_VISION_MODEL=gemini-2.0-flash
```

---

## Troubleshooting

### Authentication Issues

**401 Unauthorized:**
- Check API key is stored in localStorage
- Verify key format: `orb_<32 hex chars>`
- Try logout and re-enter key

**503 Service Unavailable (auth_not_configured):**
- Backend auth not set up
- Call POST /auth/setup or use the AuthScreen UI

**Lost API Key:**
```powershell
Get-Content D:\Orb\data\auth.json
# Look for api_key_plain field
```

**Reset Authentication:**
```powershell
del D:\Orb\data\auth.json
# Restart backend, then generate new key
```

### CORS Errors

If you see "No 'Access-Control-Allow-Origin' header":
- Verify CORS middleware in `main.py` includes `http://localhost:5173`
- Restart backend after changes

### CSP Errors (blob: images)

If image previews don't load:
- Check `index.html` CSP includes `img-src 'self' blob: data:`

### GOOGLE_API_KEY Not Found

If image analysis fails with "GOOGLE_API_KEY is not set":
- Verify `.env` file exists at `D:\Orb\.env`
- Check format: `GOOGLE_API_KEY=AIza...` (no quotes, no spaces)
- Restart backend to reload environment

### Document Q&A Not Working

If Orb can't answer questions about uploaded files:
- Delete old database: `del D:\Orb\data\orb_memory.db`
- Restart backend (recreates tables with DocumentContent)
- Re-upload files
